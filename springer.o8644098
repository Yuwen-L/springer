> setwd("/homes/yuwen/temple/springer/")
> library(springer)
> library("Rcpp")
> library("RcppArmadillo")
> # load data
> load("mydataWnt.RData")
> source("cv2.R")
> 
> p <- ncol(X)
> q=3
> n <- nrow(X)
> t <- 12
> 
> rownames(X) <- seq(1,n)
> #construct wide format y  
> ylong <- matrix(0,n,t)
> for(i in 1:t){
+   ylong[,i]<-y[seq(i, length(y), t)]
+ }
> colnames(ylong)<-c("v1","v2","v3","v4","v5","v6","v7","v8","v9","v10","v11","v12")
> 
> #construct enviromental factors
> age <- matrix(0,n,t)
> gender <- matrix(0,n,t)
> trt <- matrix(0,n,t)
> e1 <- Clinical[,1]
> e2 <- Clinical[,2]
> e3 <- Clinical[,3]
> for(i in 1:t){
+   age[,i]<-e1[seq(i, length(e1), t)]
+   gender[,i]<-e2[seq(i, length(e2), t)]
+   trt[,i]<-e3[seq(i, length(e3), t)]
+ }
> 
> e <- data.frame(trt[,1],age[,1],gender[,1])
> colnames(e) <- c("trt","age","gender")
> 
> #initial values
> beta0 <- rep(0.2,p+q+p*q+1)
> 
> #environmental factors and portion of SNP data
> mydata <- cbind(e,X)
> head(mydata)[,1:9]
  trt  age gender rs10948011 rs2503322 rs2984657 rs2504089 rs9462573 rs1928155
1   9  8.8      1          3         2         1         3         3         3
2   8  6.8      1          3         2         2         2         2         3
3   9  6.6      1          3         2         2         3         3         3
4   9 10.0      1          2         1         2         3         3         3
5   8  5.9      2          2         1         1         2         2         3
6   9  6.4      1          3         2         2         3         2         3
> 
> #longitudinal FEV1 response
> head(ylong)
       v1   v2   v3   v4   v5   v6   v7   v8   v9  v10  v11  v12
[1,] 1.73 1.86 1.87 2.00 2.14 2.17 2.27 2.23 2.31 2.30 2.30 2.47
[2,] 1.41 1.43 1.48 1.55 1.71 1.70 1.79 1.74 1.80 1.83 1.86 1.85
[3,] 1.46 1.48 1.46 1.12 1.43 1.80 1.68 1.94 1.93 1.95 1.94 2.23
[4,] 2.04 2.03 2.13 2.27 2.17 2.38 2.37 2.64 2.67 2.81 2.86 3.09
[5,] 1.27 1.29 1.37 1.35 1.36 1.45 1.52 1.44 1.61 1.60 1.71 1.74
[6,] 1.40 1.57 1.57 1.64 1.71 1.77 1.77 1.85 1.96 2.01 2.03 2.13
> 
> #tune
> lambda1 = seq(0.08,0.12,length.out=5)
> lambda2 = seq(0.08,0.12,length.out=5)
> 
> tunning <- cv.springer2(clin=NULL, e, X, ylong, beta0, lambda1, lambda2, nfolds=5, func="QIF", corr="exchangeable", structure="bilevel", maxits=30, tol=0.001)
> 
> lam1 <- tunning$lam1
> lam2 <- tunning$lam2
> 
> #run springer   
> beta = springer(clin=NULL, e, X, ylong, beta0, func="QIF", corr="exchangeable",
+ structure="bilevel", lam1, lam2, maxits=30, tol=0.01)
> 
> #beta[1:(1+q)]=0
> main <- beta[(1+q+1):(1+q+p)]
> interaction <- beta[-(1:(1+q+p))]
> age <- interaction[seq(1, length(interaction), q)]
> gender <- interaction[seq(2, length(interaction), q)]
> trt <- interaction[seq(3, length(interaction), q)]
> SNP <- colnames(X)
> 
> coef <- cbind(SNP,main,trt,age,gender)
> #copy to excel
> #write.table(coef, "clipboard", sep="\t", row.names=FALSE)
> save(list=ls(all=TRUE),file="springer.RData")
> 
